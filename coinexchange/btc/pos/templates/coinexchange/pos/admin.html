{% extends "coinexchange/leftnav.html" %}

{% block title %}
POS Admin - {{user.username}}
{% endblock %}

{% block innercontent %}
<ul class="nav nav-tabs" id="posTab">
	<li class="active"><a data-toggle="tab" href="#account">Account Home</a></li>
	<li><a data-toggle="tab" href="#batch">Completed Batches</a></li>
	<li><a data-toggle="tab" href="#newbatch">Current Batch</a></li>
</ul>
<div class="tab-content">
	<div class="tab-pane active" id="account">
		<h4>Welcome</h4>
		<p>
			Add aggregates and reports about transaction batches for monthly
			reconciliation here.<br/>
			<a class="coinexchange-help glyphicon glyphicon-question-sign" help-document="testing" help-title="Test Help Document"></a>
			
		</p>
		<p>
			<div class="input-group date col-md-2" style="float:right;">
				<input type="text" class="form-control" id="end_date"/>
				<span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
			</div>
			<div class="input-group date col-md-2">
				<input type="text" class="form-control" id="start_date"/>
				<span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
			</div>

		</p>
	</div>
	<script type="application/javascript">
		$('.input-group.date').datepicker({});
	</script>
	<div class="tab-pane" id="newbatch">
		{% if unbatched_tx %}
		<button id="makebatch" style="float:right;" class="btn btn-primary">Make Batch</button>
		{% endif %}
		<h3>Unbatched POS Transactions</h3>
		<table class="table table-condensed table-striped">
			<tr>
				<th>Amount</th>
				<th>Exchange Rate</th>
				<th>Timestamp</th>
				<th>Status</th>
				<th>Blockchain<br/>Details</th>
			</tr>
		{% for tx in unbatched_tx %}
			<tr>
				<td>{{tx.amount|floatformat:2}}</td>
				<td>{{tx.currency_btc_exchange_rate|floatformat:2}}</td>
				<td>{{tx.tx_timestamp}}</td>
				<td>
					{% if tx.tx_detail %}
					{{tx.tx_detail.confirmations}}
					{% elif tx.coinbase_tx_detail %}
					{{tx.coinbase_tx_detail.status}}
					{% endif %}
				</td>
				<td>
					<a class="btn btn-default" href="http://blockchain.info/tx/{{tx.btc_txid}}" target="_blank">
						<span class="glyphicon glyphicon-info-sign"></span>
					</a>

				</td>
			</tr>
		{% endfor %}
		</table>
	</div>
	<div class="tab-pane" id="batch">
		<h3>Transaction Batches</h3>
		<table class="table table-condensed table-striped">
			<tr>
				<th>Details</th>
				<th>BTC</th>
				<th>Average<br/>Exchange Rate</th>
				<th>Captured<span class="glyphicon glyphicon-usd"></span></th>
				<th>Realized<span class="glyphicon glyphicon-usd"></span></th>
				<th>Gain/Loss</th>
				<th>Timestamp</th>
				<th>Blockchain<br/>Details</th>
			</tr>
			{% for batch in batches %}
			<tr class="batch_row" batchid="{{batch.id}}">
				<td>
					<a href="{% url 'pos_batch' batch.id %}">
						<button class="btn btn-primary">
							Details
						</button>
					</a>
				</td>
				<td>{{batch.btc_amount}}</td>
				<td>{{batch.captured_avg_exchange_rate|floatformat:2}}</td>
				<td>{{batch.captured_amount|floatformat:2}}</td>
				<td>{{batch.total_realized_value|floatformat:2}}</td>
				<td>
					{% if batch.coinbase_payout %}
						{% if batch.batch_amount %}
						<span class="btn {% if batch.realized_gain > 0 %}btn-success{% else %}btn-warning{% endif %}">
							{{batch.realized_gain|floatformat:2}}
						</span>
						{% else %}
						<span class="btn btn-danger">Pending</span>
						{% endif %}
					{% else %}
						<span class="btn btn-info">BTC Transfer</span>
					{% endif %}
				</td>
				<td>{{batch.batch_timestamp}}</td>
				<td>
					{% if batch.txid %}
					<a class="btn btn-default" href="http://blockchain.info/tx/{{batch.txid}}?show_adv=true" target="_blank">
						<span class="glyphicon glyphicon-link"></span>
					</a>
					{% else %}
					-
					{% endif %}
				</td>
			</tr>
			{% endfor %}
		</table>
	</div>
</div>

<script type="application/javascript">
// $('.batch_row').bind("click", function(ev){
	// var batch_id = $(ev.currentTarget).attr('batchid');
	// window.location.href = "/account/pos/batch/"+batch_id;
// });
$('#makebatch').bind("click", function(){
	$.ajax({
		type: 'GET',
		url: '{% url "pos_make_batch" %}',
		dataType: 'json',
		success: function(data, textStatus, xhr){
			if(data.error){
				alert(data.status);
			}else{
				alert("Batch created.");
				location.reload();
			}
		},
		error: function(xhr, textStatus, errorThrown){
			alert("Unable to make batch. "+textStatus);
		}
	});
});

</script>

{% endblock %}
